
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>My Adventure Through Code</title>
	<meta name="author" content="Carlos Lazo">

	
	<meta name="description" content="Mar 22nd, 2015 rails, ruby, screencast Comments Mini New Relic in Ruby Another Ruby screencast coming your way! One of the downsides to working at &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="My Adventure Through Code" type="application/atom+xml">
	
	<link rel="canonical" href="http://carlosplusplus.github.io/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	
  
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-45780764-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("carlos.jose.lazo@gmail.com") + "?s=200' alt='Profile Picture' style='width: 200px;' />");
		});
	</script>
	
</div>

<nav id="main-nav"><!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
    <li><a href="/atom.xml">RSS</a></li>
        
</ul>

<section class="about">
  <div>Changing the World</dev>
  <div>One Line of Code at a Time</div>
  <div style="color: #0099FF">You Must Construct Additional Pylons</div>
</section></nav>
<nav id="sub-nav">
	<div class="social">
		
			<a class="email" href="mailto:carlos.jose.lazo@gmail.com" title="Email">Email</a>
		
		
			<a class="facebook" href="http://www.facebook.com/carlosjoselazo" title="Facebook">Facebook</a>
		
		
		
			<a class="twitter" href="http://twitter.com/carlosplusplus" title="Twitter">Twitter</a>
		
		
			<a class="github" href="https://github.com/carlosplusplus" title="GitHub">GitHub</a>
		
		
			<a class="coderwall" href="https://coderwall.com/cjlwired" title="Coderwall">Coderwall</a>
		
		
		
			<a class="linkedin" href="http://www.linkedin.com/in/carlosjlazo" title="LinkedIn">LinkedIn</a>
		
		
		
		
		
		
			<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-03-22T17:20:00-04:00" data-updated="true" itemprop="datePublished">Mar 22<span>nd</span>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>, <a class='category' href='/blog/categories/screencast/'>screencast</a>


</div>
		
			<span class="comments"><a href="/blog/2015/03/22/mini-new-relic-in-ruby/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/03/22/mini-new-relic-in-ruby/" itemprop="url">Mini New Relic in Ruby</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Another Ruby screencast coming your way!</p>

<p>One of the downsides to working at large companies (1000+ employees) is that is generally takes longer to get things done. My work colleague and I were interested in using <a href="http://en.wikipedia.org/wiki/New_Relic">New Relic</a> to monitor the performance of our Rails applications in production, but the request was taking far too long and we were tired of waiting.</p>

<p>We took matters into our own hands and wrote a quick Ruby script, our mini version of New Relic, to give us insight into how our APIs were being used. It&rsquo;s easy to forget that while Rails can do a lot for us, the Ruby programming language itself is powerful and can be used to drum up quick prototypes and scripts for a variety of uses.</p>

<p>This is the quick and dirty script we came up with at work:</p>

<p style="text-align:center;"><iframe width="480" height="385" src="http://www.youtube.com/embed/uiXdKmVthkY?hd=1" frameborder="0" allowfullscreen></iframe></p>

<p>Here is a link to a GitHub gist that contains the code:
<a href="https://gist.github.com/CarlosPlusPlus/e10ec08f52cda173eb24">log_counter.rb</a></p>

<p>Hope you found this useful &ndash; until next time!</p>

<p>CJL</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-03-17T09:22:00-04:00" data-updated="true" itemprop="datePublished">Mar 17<span>th</span>, 2015</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/orms/'>orms</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>, <a class='category' href='/blog/categories/screencast/'>screencast</a>


</div>
		
			<span class="comments"><a href="/blog/2015/03/17/ruby-orms-and-thundercats/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/03/17/ruby-orms-and-thundercats/" itemprop="url">Ruby ORMs and Thundercats</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Sincerest apologies for spending so much time away! Needed a break, and now with the mental batteries recharged, it&rsquo;s time to get back to it. Excuses are easy, so need to be better and more consistent with my technical writing and this blog.</p>

<p>Decided to try something completely new and made a ScreenCast almost two months ago regarding Ruby ORMs (<a href="http://en.wikipedia.org/wiki/Object-relational_mapping">Object Relational Mappings</a>) and <a href="http://en.wikipedia.org/wiki/ThunderCats_(1985_TV_series)">Thundercats</a>. Had a lot of fun doing this.</p>

<p style="text-align:center;"><iframe width="480" height="385" src="http://www.youtube.com/embed/PjKtaQC4GLE?hd=1" frameborder="0" allowfullscreen></iframe></p>

<p>Here is a link to a GitHub gist that contains the code:
<a href="https://gist.github.com/CarlosPlusPlus/b6497d90df7c79aa4b59">thundercats.rb</a></p>

<p>Let me know what you think in the comments below.</p>

<p>Looking forward to doing this again!</p>

<p>CJL</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-10-06T22:25:00-04:00" data-updated="true" itemprop="datePublished">Oct 6<span>th</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		
			<span class="comments"><a href="/blog/2014/10/06/micropost-ruby-number-to-s-method/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/10/06/micropost-ruby-number-to-s-method/" itemprop="url">MicroPost: Ruby&#8217;s Integer #to_s Method</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>I&rsquo;m GOING to make time for this blog. I&rsquo;ve found tech blogging so therapeutic in the past, and it really doesn&rsquo;t need to be a huge chore. Deciding to finally saddle up and do this MicroPost idea I&rsquo;ve had for quite some time. No huge, elaborate posts &ndash; instead, small little morsels of awesome.</p>

<p>Alright, so here goes! First one is about Ruby&rsquo;s <strong>Integer#to_s</strong> (to string) method.</p>

<h3>Ruby&rsquo;s Integer#to_s Method</h3>

<p>As I continue to level up my Ruby, I continue to be amazed by the beauty of the language.</p>

<p>I remember wayyyy back in High School and even in my Digital Logic Design college courses how I would constantly use binary (base 2), octal (base 8), and hexadecimal (base 16) number systems more than decimal (base 10). As I work through <strong><a href="http://www.projecteuler.net">Project Euler</a></strong> problems for coding practice, I saw Problem 36:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;&lt;-</span><span class="no">PROBLEM</span>
</span><span class='line'>
</span><span class='line'><span class="sh">The decimal number, 585 = 10010010012 (binary), is palindromic in both bases.</span>
</span><span class='line'><span class="sh">Find the sum of all numbers, less than one million, which are palindromic in base 10 and base 2.</span>
</span><span class='line'><span class="sh">(Please note that the palindromic number, in either base, may not include leading zeros.)</span>
</span><span class='line'>
</span><span class='line'><span class="no">PROBLEM</span>
</span></code></pre></td></tr></table></div></figure>


<p>Awesome, makes sense &ndash; here&rsquo;s my solution first, with some cool points to follow:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">String</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">palindrome?</span>
</span><span class='line'>    <span class="nb">self</span> <span class="o">==</span> <span class="nb">self</span><span class="o">.</span><span class="n">reverse</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">is_double_palindrome?</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'>  <span class="n">n</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">palindrome?</span> <span class="o">&amp;&amp;</span> <span class="n">n</span><span class="o">.</span><span class="n">to_s</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">palindrome?</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">solution</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">999999</span><span class="p">)</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">is_double_palindrome?</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">inject</span><span class="p">(</span><span class="ss">:+</span><span class="p">)</span>
</span><span class='line'><span class="nb">puts</span> <span class="s2">&quot;Sum of all numbers &lt; 1E6 which are palindromic in B10 &amp; B2 = </span><span class="si">#{</span><span class="n">solution</span><span class="si">}</span><span class="s2">&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>I <strong>love</strong> how Ruby lets you <strong><a href="http://en.wikipedia.org/wiki/Monkey_patch">monkey-patch</a></strong> base classes like <code>String</code>.</li>
<li>Ruby&rsquo;s <code>Integer#to_s</code> <strong><a href="http://www.ruby-doc.org/core-2.1.3/Fixnum.html#method-i-to_s">method</a></strong> can take an argument, which does a numeric base conversion!</li>
<li>Methods like <code>Enumerable#select</code> [<strong><a href="http://ruby-doc.org/core-2.1.3/Enumerable.html#method-i-select">link</a></strong>] and <code>Enumerable#inject</code> [<strong><a href="http://ruby-doc.org/core-2.1.3/Enumerable.html#method-i-inject">link</a></strong>] are <strong>so damn cool</strong>.</li>
</ol>


<p>No need for elaborate classes or modules &ndash; short, sweet, and to the point!</p>

<br>


<hr />

<p>That&rsquo;s it for this post &ndash; until next time, keep being awesome.</p>

<p>CJL</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-02-22T12:00:00-05:00" data-updated="true" itemprop="datePublished">Feb 22<span>nd</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/delayedjob/'>delayedjob</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		
			<span class="comments"><a href="/blog/2014/02/22/synchronous-ruby-tasks-with-delayedjob/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/02/22/synchronous-ruby-tasks-with-delayedjob/" itemprop="url">Synchronous Ruby Processing With DelayedJob</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>As promised in my previous entry, it&rsquo;s time to talk about how one can better optimize asynchronous tasks in the Ruby programming language via <strong>DelayedJob</strong>. If you haven&rsquo;t already, I strongly recommend you read my <strong><a href="http://carlosplusplus.github.io/blog/2014/02/01/testing-rake-tasks-with-rspec/">last blog post</a></strong>, as I will be using the example presented there.</p>

<p>So, what the deal with <em>synchronization</em> and why should we care?</p>

<h2>Asynchronous&hellip; Synchronous&hellip; Huh?</h2>

<p>Let&rsquo;s first take a look at what these two words mean, in their simplest forms:</p>

<blockquote><p><strong>Asynchronous</strong> &ndash; NOT occurring at the same time.</p>

<p><strong>Synchronous</strong> &ndash;  occurring at the same time.</p></blockquote>

<p>When we first start learning Ruby, or most programming languages, we are taught to think of events as asynchronous. In other words, a program is:</p>

<ol>
<li>Executed in the order it is written.</li>
<li>Run from top-to-bottom in a serial, non-parallel fashion.</li>
<li>The next line runs after the previous completes.</li>
</ol>


<p>There are, however, situations where you may want to think synchronously. In other words, perhaps it may be preferable for events to happen at the same time, or more commonly, <strong>in the background</strong>. This would allow your web application to keep servicing operations while intense work was being performed elsewhere. A few uses cases for this may be:</p>

<ul>
<li>Batch imports of updates to your database.</li>
<li>HTTP downloads (steaming intensive operations).</li>
<li>Image resizing (size intensive operations).</li>
<li>Sending mass emails (newsletters) to your user base.</li>
</ul>


<p>Let&rsquo;s explore the use case for batch updates as it relates to Rails rake tasks.</p>

<h2>Issue with Previous Rake Task Implementation</h2>

<p>As described in my <strong><a href="http://carlosplusplus.github.io/blog/2014/02/01/testing-rake-tasks-with-rspec/">last blog post</a></strong>, I implemented a set of Rake tasks that recomputed custom counter caches for some of my Rails models. While the solution certainly solved the problem, it was implemented in an asynchronous fashion. In other words, each <strong>unit of work</strong> needed to complete before the previous one. In this case, a unit of work was equal to one model having its counter caches recomputed.</p>

<p>To highlight the severity of the issue, here&rsquo;s a look at what the full rake task does:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">namespace</span> <span class="ss">:mongo_import</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">MODELS</span>    <span class="o">||=</span> <span class="sx">%w(answer comment question resource)</span>
</span><span class='line'>  <span class="no">WORK_SIZE</span> <span class="o">||=</span> <span class="mi">1000</span><span class="o">.</span><span class="n">freeze</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s1">&#39;Rebuilds ALL aggregation columns and counter caches.&#39;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:aggregation</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">MODELS</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span> <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s2">&quot;mongo_import:aggregation_</span><span class="si">#{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="o">].</span><span class="n">invoke</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, there are a total of four (4) rake tasks that will be run in sequence, each with varying levels of work based on the number of models present in the database and the amount of counter caches for each model. Given that this work needs to be done while the data set is in production, these rake tasks need to finish fast &ndash; this is impossible with the current implementation. Wouldn&rsquo;t it be great if there was a way to split up this work and run these tasks in parallel, or synchronously, in order to get the task done faster?</p>

<p>Let&rsquo;s see what <code>DelayedJob</code> can do for us.</p>

<h2>DelayedJob to the Rescue</h2>

<p>For those who have never heard of or used <code>DelayedJob</code>, I recommend you check out the following resources: <strong><a href="https://github.com/collectiveidea/delayed_job">DelayedJob Github Repository</a></strong> and <strong><a href="http://railscasts.com/episodes/171-delayed-job">RailsCast on DelayedJob</a></strong>. DelayedJob integrates pretty seamlessly with Rails applications and different database configurations, like SQLite3 and MongoDB. The documentation provides great use cases for when / why you would want to use this service.</p>

<h3>Background Process and Workers</h3>

<p>I won&rsquo;t go into the specific implementation detail getting setup with DelayedJob (check out the documentation), but I do want to mention a few key concepts that are important:</p>

<blockquote><p><strong>Enqueue</strong>: add unit of work to DelayedJob priority queue for processing.</p>

<p><strong>Perform</strong>: method required for DelayedJob to recognize class as actionable.</p>

<p><strong>Workers</strong>: specific background processes setup to handle <strong>units of work</strong>.</p></blockquote>

<p>At the high level, your processing work flow will probably look something like this:</p>

<ol>
<li>Spin up an amount of workers based on (a) server capability and (b) need.</li>
<li>Enqueue DelayedJobs whenever required (e.g. mass mailings and rake tasks).</li>
<li>Workers will perform queued up jobs as soon as they are &lsquo;free&rsquo; for processing.</li>
</ol>


<p>Great &ndash; let&rsquo;s dive into some code and see how I re-did my rake task.</p>

<h3>Plan of Attack</h3>

<p>The following was the original <strong>asynchronous</strong> code. Notice how each individual model must be updated before the next one can be processed. This is a great time to think about <strong><a href="http://en.wikipedia.org/wiki/Big_O_notation">O(n)</a></strong> &ndash; in other words, how would this algorithm (loop) perform as <code>Question.all</code> gets infinitely large? With the current implementation, not too well &ndash; it would act as a bottleneck for the application, potentially halting other requests from being served:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Aggregation Task for: Question&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:aggregation_question</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">Question</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">batch_size</span><span class="p">(</span><span class="no">WORK_SIZE</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">q</span><span class="o">|</span>
</span><span class='line'>    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">answers_count</span>          <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">answers</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>    <span class="n">approved_answers_count</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">answers</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">approved</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">attrs</span><span class="o">[</span><span class="ss">:answers_count</span><span class="o">]</span>          <span class="o">=</span> <span class="n">answers_count</span>          <span class="k">unless</span> <span class="n">answers_count</span><span class="o">.</span><span class="n">zero?</span>
</span><span class='line'>    <span class="n">attrs</span><span class="o">[</span><span class="ss">:approved_answers_count</span><span class="o">]</span> <span class="o">=</span> <span class="n">approved_answers_count</span> <span class="k">unless</span> <span class="n">approved_answers_count</span><span class="o">.</span><span class="n">zero?</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Question</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="k">unless</span> <span class="n">attrs</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>What I want to do is abstract the computation itself to a <code>DelayedJob</code> task. Instead of processing on <code>Question.all</code> asynchronously, let&rsquo;s use the current <code>WORK_SIZE</code> constant to <code>slice</code> models in groups and <code>enqueue</code> them via DelayedJob. It&rsquo;s also important to be mindful of making optimized database calls, as you don&rsquo;t want to be slamming your database with unnecessary processing.</p>

<p>Now with our plan of attack in place, let&rsquo;s get to work.</p>

<h3>Rake Task Implementation via DelayedJob</h3>

<p>Even though this blog post will only cover the rake task for the <code>Question</code> model, I know that I&rsquo;ll want to mimic this same structure for all four (4) of my rake tasks. Let&rsquo;s take advantage of some <strong>inheritance</strong> by creating a <code>AggregationRootJob</code> which will take care of our storing our id slices:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># lib/mongo_migrator/aggregation_root_job.rb</span>
</span><span class='line'><span class="k">module</span> <span class="nn">MongoMigrator</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">AggregationRootJob</span>
</span><span class='line'>    <span class="kp">attr_reader</span> <span class="ss">:ids</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@ids</span> <span class="o">=</span> <span class="n">ids</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Remember all that logic I used to have in my core rake task for the model?
Let&rsquo;s abstract that out to a class, called <code>AggregationQuestionJob</code>, which uses the <code>ids</code> attribute from <code>AggregationRootJob</code> to perform work on specific models in the database.</p>

<p>In order for this class to be recognized by DelayedJob, it must contain a <code>perform</code> method, which will be responsible for performing the specific unit of work:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">MongoMigrator</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">AggregationQuestionJob</span> <span class="o">&lt;</span> <span class="no">AggregationRootJob</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">perform</span>
</span><span class='line'>      <span class="no">Question</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">:id</span><span class="o">.</span><span class="n">in</span> <span class="o">=&gt;</span> <span class="n">ids</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">q</span><span class="o">|</span>
</span><span class='line'>        <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">answers_count</span>          <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">answers</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>        <span class="n">approved_answers_count</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">answers</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">approved</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">attrs</span><span class="o">[</span><span class="ss">:answers_count</span><span class="o">]</span>          <span class="o">=</span> <span class="n">answers_count</span>          <span class="k">unless</span> <span class="n">answers_count</span><span class="o">.</span><span class="n">zero?</span>
</span><span class='line'>        <span class="n">attrs</span><span class="o">[</span><span class="ss">:approved_answers_count</span><span class="o">]</span> <span class="o">=</span> <span class="n">approved_answers_count</span> <span class="k">unless</span> <span class="n">approved_answers_count</span><span class="o">.</span><span class="n">zero?</span>
</span><span class='line'>
</span><span class='line'>        <span class="no">Question</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="k">unless</span> <span class="n">attrs</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now with all this setup, we can finally rewrite our aggregation rake task as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Aggregation task for: Question&#39;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:aggregation_question</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">Question</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span><span class="o">.</span><span class="n">batch_size</span><span class="p">(</span><span class="no">WORK_SIZE</span><span class="p">)</span><span class="o">.</span><span class="n">each_slice</span><span class="p">(</span><span class="no">WORK_SIZE</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">batch</span><span class="o">|</span>
</span><span class='line'>      <span class="ss">Delayed</span><span class="p">:</span><span class="ss">:Job</span><span class="o">.</span><span class="n">enqueue</span><span class="p">(</span><span class="ss">MongoMigrator</span><span class="p">:</span><span class="ss">:AggregationQuestionJob</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:id</span><span class="p">)))</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Holy nested statements Batman!</strong> Let&rsquo;s break down what this is doing:</p>

<ol>
<li>Since I know I&rsquo;m iterating over my database, I&rsquo;ve optimized my Mongoid (MongoDB) query.

<ul>
<li>For each question, load only the <code>id</code> field, as that&rsquo;s all I need.</li>
<li>Load models into memory in batches of 1000 via <code>each_slice</code> method.</li>
</ul>
</li>
<li>For each batch, generate an array of all model id&rsquo;s via <code>collect(&amp;:id)</code>.</li>
<li>Pass the id array into a new <code>AggregationQuestionJob</code> via <code>initialize</code> method.</li>
<li>Enqueue the job via <code>Delayed::Job.enqueue</code> for workers to process when ready.</li>
<li>Sit back, relax, and profit.</li>
</ol>


<p>Now, instead of processing each individual job one by one, a queue of DelayedJobs waiting to be processed by workers is built as fast as possible. Pretty awesome!</p>

<h3>The Awesome Doesn&rsquo;t End Here!</h3>

<p>It&rsquo;s also worth noting that <code>DelayedJob</code> gives you a some cool tricks via the <code>enqueue</code> method:</p>

<blockquote><p><strong><a href="https://github.com/collectiveidea/delayed_job#hooks">Hooks</a></strong> &ndash; methods similar to ActiveRecord callbacks (e.g. after, before, failure, success).</p>

<p><strong><a href="https://github.com/collectiveidea/delayed_job#named-queues">Named Queues</a></strong> &ndash; you can have multiple queues with custom worker assignments to each.</p>

<p><strong><a href="https://github.com/collectiveidea/delayed_job#gory-details">Priority</a></strong> &ndash; set the relative priority of your Jobs for your worker processing.</p></blockquote>

<p>I recommend checking these out and taking advantage of this customization!</p>

<h2>Closing Thoughts</h2>

<p>To give you an idea of how much this improved the rake task&rsquo;s performance &ndash; with 2 workers, from start to end, the time went from 200 minutes (~3hrs) to 20 minutes, a <strong>10x improvement</strong>! And this was only on my development server &ndash; me and my team are planning to spin up more workers in production to (1) improve performance and (2) decrease overall downtime while this migration is happening.</p>

<p><code>DelayedJob</code> is an incredible tool you should definitely consider trying out.</p>

<p>Keep calm and carry on!</p>

<p>CJL</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-02-01T08:00:00-05:00" data-updated="true" itemprop="datePublished">Feb 1<span>st</span>, 2014</time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/rake/'>rake</a>, <a class='category' href='/blog/categories/rspec/'>rspec</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>, <a class='category' href='/blog/categories/testing/'>testing</a>


</div>
		
			<span class="comments"><a href="/blog/2014/02/01/testing-rake-tasks-with-rspec/#disqus_thread">Comments</a></span>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/02/01/testing-rake-tasks-with-rspec/" itemprop="url">Testing Rake Tasks With RSpec</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>One of the projects I&rsquo;m currently supporting at work involves migrating an entire database from the <a href="http://www.oracle.com/index.html">Oracle</a> framework to the <a href="http://www.mongodb.org/">MongoDB</a> framework. This Rails application is crucial in that it serves as one of the primary JSON APIs for my company&rsquo;s web services.</p>

<p>My colleagues had written an import task which will takes the (deprecated) Oracle versions of our models and migrate them to the new MongoDB representations. However, there are aggregation columns and custom <a href="http://railscasts.com/episodes/23-counter-cache-column">counter caches</a> that must be recomputed once the migration is done. I was asked to write a rake task to perform this operation on all relevant models. It was also recommended I find a way to test this locally, as the task was going to be performed on millions of rows of data in production, making it imperative to get it right the first time.</p>

<p>This blog post assumes some knowledge about <a href="https://github.com/thoughtbot/factory_girl">FactoryGirl</a> and <a href="http://relishapp.com/rspec">RSpec</a> for testing purposes. Be sure to read up on these incredible testing tools in Ruby if you haven&rsquo;t used them before.</p>

<p>Alright, time to dive in head first. Let&rsquo;s first talk about our model.</p>

<h2>The Model Space</h2>

<p>The Rails model I&rsquo;ll be using is <strong>Question</strong>. The <code>Mongoid</code> Ruby driver is used instead of <code>ActiveRecord</code> &ndash; I&rsquo;ll do my best to explain any Mongoid syntax in case you have never worked with MongoDB.</p>

<p>Here are the parts of the <strong>Question</strong> model we care about in the Rails app:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># app/models/question.rb</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Question</span>
</span><span class='line'>  <span class="kp">include</span> <span class="ss">Mongoid</span><span class="p">:</span><span class="ss">:Document</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:answers_count</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="mi">0</span>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:approved_answers_count</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">Integer</span><span class="p">,</span> <span class="ss">default</span><span class="p">:</span> <span class="mi">0</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:answers</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, what&rsquo;s happening with the code above?</p>

<ul>
<li>With Mongoid, we include the <code>Mongoid::Document</code> module.

<ul>
<li>An individual instance of a model is known as a <code>document</code>.</li>
<li>The group of all Question models is known as a <code>collection</code>.</li>
</ul>
</li>
<li>With Mongoid, our schema is defined <strong>within the model</strong>.

<ul>
<li>This means there are no migrations to run.</li>
<li>We define fields: <code>answers_count</code> and <code>approved_answers_count</code>.</li>
</ul>
</li>
<li>This model <code>has_many: answers</code>, so <code>question.answers</code> should yield me its answers.</li>
</ul>


<p>Great! Now let&rsquo;s look at the rake task that will recompute those fields.</p>

<h2>Rake Task to Compute Aggregation Fields</h2>

<p>Let&rsquo;s get right to it and look at the rake task I wrote to re-compute these fields:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># lib/tasks/aggregation.rake</span>
</span><span class='line'><span class="no">WORK_SIZE</span> <span class="o">||=</span> <span class="mi">1000</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Aggregation Task for: Question&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:aggregation_question</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>
</span><span class='line'>  <span class="no">Question</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">batch_size</span><span class="p">(</span><span class="no">WORK_SIZE</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">q</span><span class="o">|</span>
</span><span class='line'>    <span class="n">attrs</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">answers_count</span>          <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">answers</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>    <span class="n">approved_answers_count</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">answers</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">approved</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">attrs</span><span class="o">[</span><span class="ss">:answers_count</span><span class="o">]</span>          <span class="o">=</span> <span class="n">answers_count</span>          <span class="k">unless</span> <span class="n">answers_count</span><span class="o">.</span><span class="n">zero?</span>
</span><span class='line'>    <span class="n">attrs</span><span class="o">[</span><span class="ss">:approved_answers_count</span><span class="o">]</span> <span class="o">=</span> <span class="n">approved_answers_count</span> <span class="k">unless</span> <span class="n">approved_answers_count</span><span class="o">.</span><span class="n">zero?</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Question</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span> <span class="k">unless</span> <span class="n">attrs</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&rsquo;s dissect what&rsquo;s happening above:</p>

<ul>
<li>I define <code>WORK_SIZE</code> to control the # of Questions I load at a time.

<ul>
<li>Attempting to load all models into memory at once is NOT recommended.</li>
</ul>
</li>
<li>Each field is computed and added to the <code>attrs</code> hash if it&rsquo;s non-zero.

<ul>
<li>Recall how the model defaults these to 0 &ndash; no need to update if not needed, right?</li>
</ul>
</li>
<li>In order to perform just one vs. multiple updates, I pass in my hash to update if non-empty.

<ul>
<li>This query is *optimized** via Mongoid / MongoDB. You&rsquo;ll have to believe me here.</li>
</ul>
</li>
</ul>


<p>Great, so now I have a rake task built. How can I test this?</p>

<h2>Contextual Magic with FactoryGirl and RSpec</h2>

<p>I have to give credit where it&rsquo;s due &ndash; this post titled <strong><a href="http://robots.thoughtbot.com/test-rake-tasks-like-a-boss">How to Test Rake Tasks Like a BOSS</a></strong> from <a href="http://www.thoughtbot.com">ThoughtBot</a> made this all possible, with a few modifications. Please read this post for a more in-depth explanation at how this upcoming RSpec context works.</p>

<h3>Sharing is Caring via RSpec Context</h3>

<p>Since I knew I was going to be performing this operation across multiple models (all with different fields), I started out by making an RSpec context (as described in the blog post):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># spec/support/shared_contexts/aggregation.rb</span>
</span><span class='line'>
</span><span class='line'><span class="n">shared_context</span> <span class="s1">&#39;aggregation&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:rake</span><span class="p">)</span>      <span class="p">{</span> <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Application</span><span class="o">.</span><span class="n">new</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:task_name</span><span class="p">)</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">top_level_description</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">let</span><span class="p">(</span><span class="ss">:task_path</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;lib/tasks/aggregation&quot;</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">subject</span>         <span class="p">{</span> <span class="n">rake</span><span class="o">[</span><span class="n">task_name</span><span class="o">]</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">loaded_files_excluding_current_rake_file</span>
</span><span class='line'>    <span class="vg">$&quot;</span><span class="o">.</span><span class="n">reject</span> <span class="p">{</span><span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="n">file</span> <span class="o">==</span> <span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">task_path</span><span class="si">}</span><span class="s2">.rake&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to_s</span> <span class="p">}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">Rake</span><span class="o">.</span><span class="n">application</span> <span class="o">=</span> <span class="n">rake</span>
</span><span class='line'>    <span class="no">Rake</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">rake_require</span><span class="p">(</span><span class="n">task_path</span><span class="p">,</span> <span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">to_s</span><span class="o">]</span><span class="p">,</span> <span class="n">loaded_files_excluding_current_rake_file</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">.</span><span class="n">define_task</span><span class="p">(</span><span class="ss">:environment</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here are the lines we care the most about:</p>

<ul>
<li><code>let(:task_name)</code> => my task_name will equal the top level description of my RSpec example.</li>
<li><code>let(:task_path)</code> => here&rsquo;s where I link to my aggregation.rake file.</li>
<li><code>subject { ... }</code> => the subject in my RSpec example will be set to my specifc rake task.</li>
</ul>


<p>This context is automagically loaded in all specs thanks to this line in <code>spec_helper.rb</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Dir</span><span class="o">[</span><span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;spec/support/**/*.rb&quot;</span><span class="p">)</span><span class="o">].</span><span class="n">sort</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="nb">require</span> <span class="n">f</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now with this context setup, let&rsquo;s move onto the Factories.</p>

<h3>It&rsquo;s a Bird&hellip; It&rsquo;s a Plane&hellip; It&rsquo;s FactoryGirl!</h3>

<p>In my RSpec tests, you will see things like the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:question</span><span class="p">)</span>
</span><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:answer</span><span class="p">,</span> <span class="ss">question</span><span class="p">:</span> <span class="n">question</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:answer</span><span class="p">,</span> <span class="ss">question</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span> <span class="ss">approved</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Factories are defined elsewhere that give me the flexibility to create new documents (models) in particular configurations. In this case, I know I want to specifically test my two aggregation fields, so I&rsquo;ll be setting those when I use my factories in my RSpec examples. So the associations are upheld, I want to assign the newly create answers to the question that was created.</p>

<p>With my factories all setup, I&rsquo;m ready to look at my RSpec tests.</p>

<h3>RSpec, Do That Voodoo That You Do So Well</h3>

<p>Now with everything in place, let&rsquo;s write some RSpec examples. I&rsquo;m going to break this up into two sections so that it&rsquo;s easier to digest.</p>

<h4>INITIALIZATION</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># spec/lib/aggregation_spec.rb</span>
</span><span class='line'><span class="n">describe</span> <span class="s1">&#39;aggregation_question&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">include_context</span> <span class="s1">&#39;aggregation&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s1">&#39;Initialization&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">its</span><span class="p">(</span><span class="ss">:prerequisites</span><span class="p">)</span> <span class="p">{</span> <span class="n">should</span> <span class="kp">include</span><span class="p">(</span><span class="s1">&#39;environment&#39;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;should initialize fields to zero&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">q</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:question</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">q</span><span class="o">.</span><span class="n">answers_count</span><span class="o">.</span><span class="n">should</span> <span class="n">be_zero</span>
</span><span class='line'>      <span class="n">q</span><span class="o">.</span><span class="n">approved_answers_count</span><span class="o">.</span><span class="n">should</span> <span class="n">be_zero</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Execution</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, what&rsquo;s going on here?</p>

<ul>
<li>The top level description of my example is purposely named <code>aggregation_question</code>.

<ul>
<li>If you recall, this is the name of my rake task, which will be set as the <code>subject</code>.</li>
</ul>
</li>
<li>For this to all work, I must include my shared_context we created previously.</li>
<li>I create a few examples to test out the initialization of my model.</li>
</ul>


<p>Awesome! This all works as intended. I know my rake task (<code>:aggregation_question</code>) is wired correctly due to the <code>:prerequisites</code> example. Now, onto the execution of the rake task.</p>

<h4>EXECUTION</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># spec/lib/aggregation_spec.rb</span>
</span><span class='line'><span class="n">describe</span> <span class="s1">&#39;aggregation_question&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">include_context</span> <span class="s1">&#39;aggregation&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Initialization</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">describe</span> <span class="s1">&#39;Execution&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">before</span> <span class="k">do</span>
</span><span class='line'>      <span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span>
</span><span class='line'>        <span class="n">question</span> <span class="o">=</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:question</span><span class="p">)</span>
</span><span class='line'>        <span class="n">n</span><span class="o">.</span><span class="n">times</span>  <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:answer</span><span class="p">,</span> <span class="ss">question</span><span class="p">:</span> <span class="n">question</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>        <span class="n">n</span><span class="o">.</span><span class="n">times</span>  <span class="p">{</span> <span class="no">FactoryGirl</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="ss">:answer</span><span class="p">,</span> <span class="ss">question</span><span class="p">:</span> <span class="n">question</span><span class="p">,</span> <span class="ss">approved</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">question</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="ss">:answers_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="n">question</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="ss">:approved_answers_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;should contain the correct instance count&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="no">Question</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="mi">3</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">it</span> <span class="s1">&#39;should properly set aggregation fields for Questions&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="no">Question</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">q</span><span class="o">|</span>
</span><span class='line'>        <span class="n">q</span><span class="o">.</span><span class="n">answers_count</span><span class="o">.</span><span class="n">should</span> <span class="n">be_zero</span>
</span><span class='line'>        <span class="n">q</span><span class="o">.</span><span class="n">approved_answers_count</span><span class="o">.</span><span class="n">should</span> <span class="n">be_zero</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">subject</span><span class="o">.</span><span class="n">invoke</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">Question</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">q</span><span class="p">,</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>        <span class="n">q</span><span class="o">.</span><span class="n">answers_count</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
</span><span class='line'>        <span class="n">q</span><span class="o">.</span><span class="n">approved_answers_count</span><span class="o">.</span><span class="n">should</span> <span class="o">==</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, onto the execution of the rake task:</p>

<ul>
<li>Using my factories, I use a loop to setup a total of three (3) questions as follows:

<ul>
<li>Q1: 2 total answers, 1 of which  is approved.</li>
<li>Q2: 4 total answers, 2 of which are approved.</li>
<li>Q3: 6 total answers, 3 of which are approved.</li>
</ul>
</li>
<li>I force my aggregation fields to 0, as counter caches are increasing upon document creation.</li>
<li>Just to be sure, I check to see that my test database has the correct number of questions.</li>
</ul>


<p>The magic all happens in my last example:</p>

<ol>
<li>First, I check to ensure all Questions I created have zero values for their aggregation fields.</li>
<li>Given that <code>subject</code> is the rake task I want to execute, I <code>invoke</code> the task, running it.</li>
<li>Based on my creation criteria, I then check to ensure all fields equal their expected values.</li>
</ol>


<p>Running these tests yields four (4) <strong>passing</strong> examples!</p>

<h2>Future Considerations</h2>

<p>Having gone through the first model in this exact fashion, I was able to write my <strong>tests first</strong> for the other models and write similar examples. However, there&rsquo;s a really big issue here that is hard to ignore.</p>

<p>While the tests are great, they in no way represent the volume of data I&rsquo;ll be finding in production. As you can see, the rake task is executed 1000 documents at a time, in serial fashion. The time this takes in unacceptable when processing millions of documents, as this data needs to be available as soon as possible. So, how can we solve this problem?</p>

<p>Stay tuned for a future blog post on how I re-did my rake task as a <code>DelayedJob</code>.</p>

<p>Thanks for reading; keep calm and carry on!</p>

<p>CJL</p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner"><div style="display:inline">
    Copyright &copy; 2015

    Carlos Lazo
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>

Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			<script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'carlosplusplus';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>




		</div>
	</div>
</body>
</html>
